<!-- modals/core/ModalManager.vue -->
<script setup lang="ts">
import { computed, defineAsyncComponent } from 'vue'
import { useModalStore } from '@/stores/modal'
import type { ModalState } from '@/types/modal'
// TODO: Uncomment these once the components are created
// import PaymentApproval from '../payment/PaymentApproval.vue'

const modalStore = useModalStore()

// Modal components mapping
const modalComponents = {
    // Token modals
    deployToken: defineAsyncComponent(() => import('../token/DeployTokenModal.vue')),
    mintTokens: defineAsyncComponent(() => import('../token/MintTokenModal.vue')),
    burnTokens: defineAsyncComponent(() => import('../token/BurnTokenModal.vue')),
    tokenSettings: defineAsyncComponent(() => import('../token/TokenSettingsModal.vue')),
    topUpCycles: defineAsyncComponent(() => import('../token/TopUpCyclesModal.vue')),

    // Wallet modals
    wallet: defineAsyncComponent(() => import('../wallet/ConnectWalletModal.vue')),
    sendToken: defineAsyncComponent(() => import('../wallet/SendTokenModal.vue')),
    receiveToken: defineAsyncComponent(() => import('../wallet/ReceiveTokenModal.vue')),
    confirmSendToken: defineAsyncComponent(() => import('../wallet/ConfirmSendTokenModal.vue')),
    addNewToken: defineAsyncComponent(() => 
        import('../token/AddNewTokenModal.vue')
    ),
    // Lock modals
    createLock: defineAsyncComponent(() => import('../lock/CreateLock.vue')),

    // Filter modals
    // tokenFilter: defineAsyncComponent(() => import('../filter/TokenFilterModal.vue'))

    //Multisig modals
    createProposal: defineAsyncComponent(() => import('../multisig/CreateProposalModal.vue')),
    manageSigners: defineAsyncComponent(() => import('../multisig/ManageSignersModal.vue')),
    signProposal: defineAsyncComponent(() => import('../multisig/SignProposalModal.vue')),
    receiveAsset: defineAsyncComponent(() => import('../multisig/ReceiveAssetModal.vue')),
    
    // Launchpad modals
    launchpadDeposit: defineAsyncComponent(() => import('../launchpad/LaunchpadDepositModal.vue')),
} as const

const currentModal = computed(() => {
    const activeModal = Object.entries(modalStore.state).find(([_, state]) => state.isOpen)
    if (!activeModal) return null

    const [modalName] = activeModal
    return modalComponents[modalName as keyof typeof modalComponents]
})

const modalProps = computed(() => {
    const activeModal = Object.entries(modalStore.state).find(([_, state]) => state.isOpen)
    if (!activeModal) return {}

    const [_, state] = activeModal
    return {
        show: true,
        data: state.data
    }
})

const handleClose = () => {
    const activeModal = Object.entries(modalStore.state).find(([_, state]) => state.isOpen)
    if (!activeModal) return

    const [modalName] = activeModal
    modalStore.close(modalName as keyof ModalState)
}
</script>

<template>
    <div class="modal-manager">
        <div>
            <Suspense>
                <component v-if="currentModal" :is="currentModal" v-bind="modalProps" @close="handleClose" />
            </Suspense>
        </div>
    </div>
</template>